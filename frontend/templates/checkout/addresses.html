{% extends 'layout/base.html' %}
{% block title %}Checkout · Direcciones{% endblock %}
{% block content %}
  <div x-data="addressesPage()" x-init="init()">
    <div class="container">
      <h1>Direcciones</h1>
      <p class="muted">Seleccioná envío y facturación para continuar.</p>

      <div class="row">
        <div class="col">
          <div class="card">
            <h2>Envío</h2>
            <template x-for="a in shipping" :key="a.id">
              <div class="addr">
                <label>
                  <input type="radio" name="shipping" :value="a.id" x-model="selected.shipping_id"> Seleccionar
                </label>
                <div>
                  <div x-text="`${a.name} — ${a.street}, ${a.city}`"></div>
                  <div class="muted" x-text="`${a.province}, ${a.zip_code}, ${a.country}`"></div>
                </div>
                <div>
                  <span class="badge" x-show="a.is_default">Default</span>
                </div>
              </div>
            </template>
            <div class="row" style="gap:8px;">
              <button class="btn" @click="openNew('shipping')">Nueva</button>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h2>Facturación</h2>
            <template x-for="a in billing" :key="a.id">
              <div class="addr">
                <label>
                  <input type="radio" name="billing" :value="a.id" x-model="selected.billing_id"> Seleccionar
                </label>
                <div>
                  <div x-text="`${a.name} — ${a.street}, ${a.city}`"></div>
                  <div class="muted" x-text="`${a.province}, ${a.zip_code}, ${a.country}`"></div>
                </div>
                <div>
                  <span class="badge" x-show="a.is_default">Default</span>
                </div>
              </div>
            </template>
            <div class="row" style="gap:8px;">
              <button class="btn" @click="openNew('billing')">Nueva</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="gap:8px;">
        <button class="btn" :disabled="!canContinue()" @click="submitSelection()">Continuar</button>
        <button class="btn btn-success" :disabled="!canContinue()" @click="confirmStep()">Confirmar direcciones</button>
      </div>

      <template x-if="message">
        <div class="card">
          <div x-text="message"></div>
        </div>
      </template>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    function addressesPage() {
      return {
        orderNumber: new URLSearchParams(window.location.search).get('order') || '',
        shipping: [],
        billing: [],
        selected: { shipping_id: null, billing_id: null },
        message: '',
        init() {
          if (!this.orderNumber) return;
          fetch(`/api/v1/checkout/${this.orderNumber}/addresses`, { headers: this.authHeaders() })
            .then(r => r.json())
            .then(d => {
              this.shipping = d.shipping || [];
              this.billing = d.billing || [];
              this.selected.shipping_id = d.selected?.shipping_address_id || d.defaults?.shipping_id || null;
              this.selected.billing_id = d.selected?.billing_address_id || d.defaults?.billing_id || null;
            });
        },
        canContinue() {
          return !!(this.selected.shipping_id && this.selected.billing_id);
        },
        submitSelection() {
          fetch(`/api/v1/checkout/${this.orderNumber}/addresses/select`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
            body: JSON.stringify({ shipping_address_id: this.selected.shipping_id, billing_address_id: this.selected.billing_id })
          }).then(r => r.json()).then(d => { this.message = 'Selección guardada'; });
        },
        confirmStep() {
          fetch(`/api/v1/checkout/${this.orderNumber}/addresses/confirm`, {
            method: 'POST', headers: this.authHeaders()
          }).then(r => r.json()).then(d => {
            if (d && d.status === 'ok') {
              this.message = 'Direcciones confirmadas. Redirigiendo a pago...';
              // Crear preferencia de MP y redirigir al init_point
              fetch(`/api/v1/payments/mp/preference`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify({ order_number: this.orderNumber })
              }).then(r => r.json()).then(p => {
                const url = p.init_point || p.sandbox_init_point;
                if (url) { window.location.href = url; }
              }).catch(() => {
                this.message = 'No se pudo iniciar el pago. Intentalo nuevamente.';
              });
            }
          });
        },
        openNew(kind) {
          const name = prompt('Nombre y apellido');
          const street = prompt('Calle y número');
          const city = prompt('Ciudad');
          const province = prompt('Provincia');
          const zip = prompt('Código postal');
          const phone = prompt('Teléfono (Ej: +54 381 …)');
          const payload = { kind, name, street, city, province, zip_code: zip, country: 'AR', phone };
          fetch(`/api/v1/checkout/${this.orderNumber}/addresses/new`, {
            method: 'POST', headers: { 'Content-Type': 'application/json', ...this.authHeaders() }, body: JSON.stringify(payload)
          }).then(r => r.json()).then(list => {
            if (kind === 'shipping') this.shipping = list; else this.billing = list;
          });
        },
        authHeaders() {
          const token = localStorage.getItem('access_token');
          return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
      }
    }
  </script>
{% endblock %}