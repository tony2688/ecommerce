name: UI Smoke

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build SCSS
        run: |
          cd frontend
          npm ci
          npm run scss:build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install backend deps and start FastAPI
        run: |
          python -m pip install --upgrade pip
          pip install "uvicorn==0.30.1" "poetry==1.8.3"
          cd backend
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-ansi
          nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 3

      - name: Prepare Nginx config (proxy public pages)
        run: |
          mkdir -p tmp
          cp docker/nginx.conf tmp/nginx.conf
          # En Actions, el contenedor Nginx accede al backend en host usando host.docker.internal
          sed -i 's/server backend:8000;/server host.docker.internal:8000;/' tmp/nginx.conf

      - name: Run Nginx container
        run: |
          docker run -d --rm --name ui_nginx -p 8080:80 \
            -v ${{ github.workspace }}/tmp/nginx.conf:/etc/nginx/nginx.conf:ro \
            -v ${{ github.workspace }}/frontend:/usr/share/nginx/html:ro \
            nginx:1.28
          sleep 2

      - name: Smoke - Home via Nginx
        run: |
          curl -sSf http://localhost:8080/ >/dev/null

      - name: Smoke - CSS MIME via Nginx
        run: |
          h=$(curl -I http://localhost:8080/static/scss/base.css | tr -d '\r')
          echo "$h"
          echo "$h" | grep -qi "Content-Type: text/css"

      - name: Cleanup
        if: always()
        run: |
          docker stop ui_nginx || true